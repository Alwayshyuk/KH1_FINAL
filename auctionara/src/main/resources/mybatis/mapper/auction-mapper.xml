<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="auction">

	<!-- 시퀸스 생성 -->
	<select id="sequence" resultType="int">
		select auction_seq.nextval from dual
	</select>

	<!-- 경매 등록 -->	
	<insert id="insert" parameterType="AuctionDto">
		insert into auction(
			auction_no, auctioneer_no, category_no, 
			auction_title, auction_content,
			auction_closed_time, auction_opening_bid, auction_closing_bid,
			auction_bid_unit, auction_status
		)
		values(
			#{auctionNo}, #{auctioneerNo}, #{categoryNo},
			#{auctionTitle}, #{auctionContent},
			to_date(#{auctionClosedTime}, 'YYYY-MM-DD HH24:MI'), #{auctionOpeningBid}, #{auctionClosingBid},
			#{auctionBidUnit}, #{auctionStatus}
		)
	</insert>
	
	<!-- 특정 회원이 가장 최근 등록한 경매 조회 -->
	<select id="recent" resultType="AuctionDto" parameterType="int">
		select * from auction where auctioneer_no = #{auctioneerNo} and auction_no = (select max(auction_no) from auction)
	</select>

	<!-- 경매 목록 조회 -->	
	<select id="list" resultType="AuctionListVO" parameterType="Map">
		select * from (
			select rownum rn, TMP.*, count(*) over() auction_count from (
			    select C.auction_no, C.auction_title, C.auction_opening_bid, C.auction_closed_time, 
			    	min(D.photo_attachment_no) photo_attachment_no, max(E.bidding_price) bidding_price			    	
			    from (select * from gps_address where 
				<if test="filter == 0">
					<![CDATA[
			    	member_no = ${memberNo}
			    	]]>
				</if>
				<if test="filter == 1">
					<![CDATA[
			    	gps_no = (select min(gps_no) from gps_address where member_no = #{memberNo})
			    	]]>
				</if>
				<if test="filter == 2">
					<![CDATA[				
			    	gps_no = (select max(gps_no) from gps_address where member_no = #{memberNo})
			    	]]>
				</if>
			    	) A, gps_address B
			    join auction C on B.member_no = C.auctioneer_no
			    join photo D on C.auction_no = D.photo_auction_no
			    left join bidding E on C.auction_no = E.auction_no
			    left join successful_bid F on C.auction_no = F.auction_no
			    where C.auction_private = 0 and F.auction_no is null and C.auction_closed_time > sysdate
			    	and distance(A.gps_latitude, A.gps_longitude, B.gps_latitude, B.gps_longitude) <![CDATA[ <= ]]> (A.gps_circle + B.gps_circle)
				<if test="keyword != null and search == 0">
					<![CDATA[		    
			    	and instr(C.auction_title, '${keyword}') > 0 or instr(C.auction_content, '${keyword}') > 0
			    	]]>
				</if>
				<if test="keyword != null and search == 1">
					<![CDATA[
			    	and instr(C.auction_title, '${keyword}') > 0
			    	]]>
				</if>
				<if test="keyword != null and search == 2">
					<![CDATA[
			    	and instr(C.auction_content, '${keyword}') > 0 
			    	]]>
				</if>
				<if test="categoryNo != null">	
					<![CDATA[			    	
			    	and C.category_no = ${categoryNo}
			    	]]>
				</if>										    	   
			    group by C.auction_no, C.auction_title, C.auction_opening_bid, C.auction_closed_time
			    order by
				<if test="sort == 1">
					<![CDATA[		    
			    	nvl(bidding_price, C.auction_opening_bid) desc,
			    	]]>
				</if>
				<if test="sort == 2">
					<![CDATA[
			    	nvl(bidding_price, C.auction_opening_bid) asc, 
			    	]]>
				</if>
				<if test="sort == 3">
					<![CDATA[				
					C.auction_closed_time asc,
			    	]]>
				</if>				
			    C.auction_no desc
		    ) TMP
	    ) where rn between ${begin} and ${end}
	</select>
	
	<!-- 경매 상세 조회 -->
	<select id="detail" resultType="AuctionDetailVO" parameterType="map">
       	select B.bidding_count, B.max_bidding_price, D.category_name, D.category_no,
        	A.auction_no, A.auctioneer_no, A.auction_title, A.auction_content, A.auction_closed_time, 
			A.auction_opening_bid, A.auction_closing_bid, A.auction_bid_unit, A.auction_status 
		<if test="bidderNo != null">
			<![CDATA[
			,C.my_bidding_price 	        
	        ,case when B.max_bidding_price = C.my_bidding_price and B.min_bidding_no = C.my_bidding_no then '1'
	            else '0'
	            end as top_bidder  
	    	]]>
		</if>  	            
        from auction A
        left join (select auction_no, count(*) bidding_count, max(bidding_price) max_bidding_price, 
        	min(bidding_no) keep(dense_rank first order by bidding_price desc) min_bidding_no from bidding 
            group by auction_no) B on A.auction_no = B.auction_no
		<if test="bidderNo != null">
			<![CDATA[
        left join (select auction_no, max(bidding_price) my_bidding_price, 
	        min(bidding_no) keep(dense_rank first order by bidding_price desc) my_bidding_no from bidding 
	        where bidder_no = #{bidderNo} group by auction_no) C
			on A.auction_no = C.auction_no 
	    	]]>
		</if>  			           
        join category D on A.category_no = D.category_no
        where A.auction_no = #{auctionNo}
        group by B.bidding_count, B.max_bidding_price, B.min_bidding_no, D.category_name, D.category_no,
            A.auction_no, A.auctioneer_no, A.auction_title, A.auction_content, A.auction_closed_time, 
			A.auction_opening_bid, A.auction_closing_bid, A.auction_bid_unit, A.auction_status
		<if test="bidderNo != null">
			<![CDATA[
       	    ,C.my_bidding_price, C.my_bidding_no	
	    	]]>
		</if>  	
	</select>

	<!-- 마감 시간이 되어서 낙찰처리가 필요한 경매 리스트 조회 -->
	<select id="finish" resultType="SuccessfulBidDto" parameterType="Date">
		select A.auction_no, B.succ_bidder_no, B.succ_final_bid, B.succ_auction_count from auction A 
		join (select auction_no, count(*) succ_auction_count, max(bidding_price) succ_final_bid, 
			min(bidding_no) keep(dense_rank first order by bidding_price desc), 
			min(bidder_no) keep(dense_rank first order by bidding_price desc) succ_bidder_no from bidding group by auction_no) B 
			on A.auction_no = B.auction_no
		left join successful_bid C on A.auction_no = C.auction_no
		where A.auction_closed_time <![CDATA[ <= ]]> #{auctionClosedTime} and C.auction_no is null and A.auction_private = 0
	</select>
	
	<!-- 즉시 낙찰 경매 정보 조회 -->
	<select id="close" resultType="SuccessfulBidDto" parameterType="int">
		select A.auction_no, B.succ_bidder_no, B.succ_final_bid, B.succ_auction_count from auction A 
		join (select auction_no, count(*) succ_auction_count, max(bidding_price) succ_final_bid, 
			min(bidding_no) keep(dense_rank first order by bidding_price desc), 
			min(bidder_no) keep(dense_rank first order by bidding_price desc) succ_bidder_no from bidding group by auction_no) B 
			on A.auction_no = B.auction_no
		left join successful_bid C on A.auction_no = C.auction_no
		where A.auction_no = ${auctionNo}
	</select>	

	<!-- 관리자 페이지 - 경매 리스트 -->
	<select id="adminList" resultType="AdminAuctionListVO" parameterType="Map">
		select * from (
	 		select rownum rn, TMP.* from (
	 			select 
				    A.auction_no, A.auction_title, A.auction_upload_time, A.auction_private,
				    M.member_name, M.member_nick,
				    C.category_name,
				    (select count(*) from auction_report AR where AR.auction_no = A.auction_no) "report_count"
				from auction A
				    inner join member M on A.auctioneer_no = M.member_no
				    inner join category C on A.category_no = C.category_no
				 <if test="type != null and keyword != null">
					 <![CDATA[
					 	where instr(${type}, #{keyword}) > 0
					 ]]>
				 </if>
			 	order by A.auction_no desc
	 		) TMP
	 	) where rn between #{begin} and #{end}
	</select>
	
	<select id="adminListCount" parameterType="Map" resultType="int">
		select 
			count(*)
		from auction A
			inner join member M on A.auctioneer_no = M.member_no
			inner join category C on A.category_no = C.category_no
		<if test="type != null and keyword != null">
		 	<![CDATA[
				where instr(${type}, #{keyword}) > 0
		 	]]>
		 </if>
	</select>
	
	<!-- 관리자 페이지 - 경매 상세 조회 -->
	<select id="adminAuctionDetail" parameterType="int" resultType="AdminAuctionDetailVO">
		select 
		    A.*,
		    M.member_name, M.member_nick,
		    C.category_name,
		    (select min(photo_attachment_no) from photo P where A.auction_no = P.photo_auction_no) "photo_attachment_no",
		    (select max(bidding_price) from bidding B where A.auction_no = B.auction_no) "max_bidding_price"
		from auction A
		    inner join member M on A.auctioneer_no = M.member_no
		    inner join category C on A.category_no = C.category_no
		where auction_no = #{auctionNo}
	</select>
	
	<!-- 관리자 페이지 - 경매 게시글 공개 처리 -->
	<update id="setOpen" parameterType="int">
		update auction set auction_private = 0 where auction_no = #{auctionNo} and auction_private = 1
	</update>
	
	<!-- 관리자 페이지 - 경매 게시글 비공개 처리 -->
	<update id="setPrivate" parameterType="int">
		update auction set auction_private = 1 where auction_no = #{auctionNo} and auction_private = 0 
	</update>
	
	<!-- 관리자 페이지 - update 후 사용할 selectOne -->
	<select id="one" parameterType="int" resultType="AuctionDto">
		select * from auction where auction_no = #{auctionNo}
	</select>

</mapper> 