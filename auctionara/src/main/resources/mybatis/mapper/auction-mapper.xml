<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="auction">

	<!-- 시퀸스 생성 -->
	<select id="sequence" resultType="int">
		select auction_seq.nextval from dual
	</select>

	<!-- 경매 등록 -->	
	<insert id="insert" parameterType="AuctionDto">
		insert into auction(
			auction_no, auctioneer_no, category_no, 
			auction_title, auction_content,
			auction_closed_time, auction_opening_bid, auction_closing_bid,
			auction_bid_unit, auction_status
		)
		values(
			#{auctionNo}, #{auctioneerNo}, #{categoryNo},
			#{auctionTitle}, #{auctionContent},
			to_date(#{auctionClosedTime}, 'YYYY-MM-DD HH24:MI'), #{auctionOpeningBid}, #{auctionClosingBid},
			#{auctionBidUnit}, #{auctionStatus}
		)
	</insert>
	
	<!-- 특정 회원이 가장 최근 등록한 경매 조회 -->
	<select id="recent" resultType="AuctionDto" parameterType="int">
		select * from auction where auctioneer_no = #{auctioneerNo} and auction_no = (select max(auction_no) from auction)
	</select>

	<!-- 경매 목록 조회 -->	
	<select id="list" resultType="AuctionListVO" parameterType="int">
		select A.auction_no, min(B.photo_attachment_no) photo_attachment_no, 
			A.auction_title, A.auction_opening_bid, max(C.bidding_price) bidding_price, A.auction_closed_time 
		from auction A
        join photo B on A.auction_no = B.photo_auction_no
        left join bidding C on A.auction_no = C.auction_no
        group by A.auction_no, A.auction_title, A.auction_opening_bid, A.auction_closed_time
        order by A.auction_no desc
	</select>
	
	<!-- 경매 상세 조회 -->
	<select id="detail" resultType="AuctionDetailVO" parameterType="map">
 		select A.bidding_count, A.max_bidding_price, D.category_name, D.category_no,
        	C.auction_no, C.auctioneer_no, C.auction_title, C.auction_content, C.auction_closed_time, 
			C.auction_opening_bid, C.auction_closing_bid, C.auction_bid_unit, C.auction_status
		<if test="bidderNo != null">
			<![CDATA[
			,B.my_bidding_price 	        
	        ,case when A.max_bidding_price = B.my_bidding_price and A.min_bidding_no = B.my_bidding_no then '1'
	            else '0'
	            end as top_bidder
	    	]]>
		</if>        
        from (select auction_no, count(*) bidding_count, max(bidding_price) max_bidding_price, 
        	min(bidding_no) keep(dense_rank first order by bidding_price desc) min_bidding_no from bidding 
        	where auction_no = #{auctionNo} group by auction_no) A
		<if test="bidderNo != null">
			<![CDATA[        	
	        join (select auction_no, max(bidding_price) my_bidding_price, 
	        	min(bidding_no) keep(dense_rank first order by bidding_price desc) my_bidding_no from bidding 
	        	where bidder_no = #{bidderNo} group by auction_no) B
				on A.auction_no = B.auction_no
			]]>
		</if>								
            join auction C on A.auction_no = C.auction_no
            join category D on C.category_no = D.category_no
        group by A.bidding_count, A.max_bidding_price, A.min_bidding_no, D.category_name, D.category_no,
            C.auction_no, C.auctioneer_no, C.auction_title, C.auction_content, C.auction_closed_time, 
			C.auction_opening_bid, C.auction_closing_bid, C.auction_bid_unit, C.auction_status
		<if test="bidderNo != null">
			<![CDATA[			
	        ,B.my_bidding_price, B.my_bidding_no
			]]>
		</if>
	</select>
	
	<!-- 마감 시간이 되어서 낙찰처리가 필요한 경매 리스트 조회 -->
	<select id="finish" resultType="SuccessfulBidDto" parameterType="Date">
		select A.auction_no, B.succ_bidder_no, B.succ_final_bid, B.succ_auction_count from auction A 
		join (select auction_no, count(*) succ_auction_count, max(bidding_price) succ_final_bid, 
			min(bidding_no) keep(dense_rank first order by bidding_price desc), 
			min(bidder_no) keep(dense_rank first order by bidding_price desc) succ_bidder_no from bidding group by auction_no) B 
			on A.auction_no = B.auction_no
		left join successful_bid C on A.auction_no = C.auction_no
		where A.auction_closed_time <![CDATA[ <= ]]> #{auctionClosedTime} and C.auction_no is null
	</select>

</mapper> 